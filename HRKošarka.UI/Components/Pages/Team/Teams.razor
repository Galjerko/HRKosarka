@page "/teams"
@using HRKošarka.UI.Services.Base

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5" Class="mb-4">Teams Management</MudText>

    <MudPaper Elevation="2" Class="pa-4 mb-4 team-filter-card" Square="false">
        <div class="team-filters-header">
            <MudIcon Icon="@Icons.Material.Filled.FilterAlt" Color="Color.Secondary" Class="mr-2" />
            <MudText Typo="Typo.h6" Class="team-filters-title">Filter Teams</MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Text"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Refresh"
                       OnClick="ResetFilters"
                       Class="filter-reset-btn">Reset</MudButton>
        </div>
        <div class="team-filters-container">
            <MudTextField @bind-Value="_searchTerm"
                          Placeholder="Search teams..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true"
                          DebounceInterval="300"
                          OnDebounceIntervalElapsed="@OnSearchChanged"
                          Variant="Variant.Outlined"
                          Class="team-filter-field" />

            <MudSelect T="Guid?" @bind-Value="FilterAgeCategory"
                       Label="Age Category"
                       Variant="Variant.Outlined"
                       Dense="true"
                       Clearable="true"
                       Class="team-filter-field">
                <MudSelectItem T="Guid?" Value="@null">All Categories</MudSelectItem>
                @foreach (var cat in _ageCategories)
                {
                    <MudSelectItem T="Guid?" Value="@cat.Id">
                        <MudIcon Icon="@Icons.Material.Filled.Category" Class="mr-1" Size="Size.Small" />
                        @cat.Code
                    </MudSelectItem>
                }
            </MudSelect>

            <MudSelect T="Gender?" @bind-Value="FilterGender"
                       Label="Gender"
                       Variant="Variant.Outlined"
                       Dense="true"
                       Clearable="true"
                       Class="team-filter-field">
                <MudSelectItem T="Gender?" Value="@null">All Genders</MudSelectItem>
                <MudSelectItem T="Gender?" Value="Gender._0">
                    <MudIcon Icon="@Icons.Material.Filled.Man" Class="mr-1" Color="Color.Primary" Size="Size.Small" />
                    Male
                </MudSelectItem>
                <MudSelectItem T="Gender?" Value="Gender._1">
                    <MudIcon Icon="@Icons.Material.Filled.Woman" Class="mr-1" Color="Color.Secondary" Size="Size.Small" />
                    Female
                </MudSelectItem>
            </MudSelect>

            <MudSelect T="bool?" @bind-Value="FilterActive"
                       Label="Status"
                       Variant="Variant.Outlined"
                       Dense="true"
                       Clearable="true"
                       Class="team-filter-field">
                <MudSelectItem T="bool?" Value="@null">All Status</MudSelectItem>
                <MudSelectItem T="bool?" Value="true">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Class="mr-1" Size="Size.Small" />
                    Active
                </MudSelectItem>
                <MudSelectItem T="bool?" Value="false">
                    <MudIcon Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" Class="mr-1" Size="Size.Small" />
                    Inactive
                </MudSelectItem>
            </MudSelect>
        </div>
    </MudPaper>

    <MudTable @ref="_table"
              ServerData="LoadServerData"
              SortLabel="Sort by"
              Loading="_loading"
              Hover="true"
              Striped="true"
              Dense="true"
              FixedHeader="true"
              Height="600px">

        <HeaderContent>
            <MudTh><MudTableSortLabel T="TeamDTO" SortLabel="Name">Name</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel T="TeamDTO" SortLabel="ClubName">Club</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel T="TeamDTO" SortLabel="Gender">Gender</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel T="TeamDTO" SortLabel="AgeCategoryName">Age Category</MudTableSortLabel></MudTh>
            <MudTh>Status</MudTh>
            <MudTh Style="text-align: center">Actions</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd DataLabel="Name">@context.Name</MudTd>
            <MudTd DataLabel="Club">@context.ClubName</MudTd>
            <MudTd DataLabel="Gender">@((context.Gender == Gender._0) ? "Male" : "Female")</MudTd>
            <MudTd DataLabel="Age Category">@context.AgeCategoryName</MudTd>
            <MudTd DataLabel="Status">
                <MudChip T="string" Color="@(context.IsActive ? Color.Success : Color.Error)" Size="Size.Small">
                    @(context.IsActive ? "Active" : "Inactive")
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Actions" Style="text-align: center">
                <MudButtonGroup Variant="Variant.Text" Size="Size.Small">
                    <MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Primary" Size="Size.Small" OnClick="@(() => ViewTeam(context.Id))" Title="View Details" />
                    @if (_canEdit && context.IsActive)
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Secondary" Size="Size.Small" OnClick="@(() => EditTeam(context.Id, context.Name))" Title="Edit Team" />
                    }
                    @if (_canDeactivate && context.IsActive)
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.Block" Color="Color.Warning" Size="Size.Small" OnClick="@(() => DeactivateTeam(context.Id, context.Name))" Title="Deactivate Team" />
                    }
                    else @if (_canDeactivate && !context.IsActive)
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.PlayArrow" Color="Color.Success" Size="Size.Small" OnClick="@(() => ActivateTeam(context.Id, context.Name))" Title="Activate Team" />
                    }
                    @if (_canDelete)
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => DeleteTeam(context.Id, context.Name))" Title="Delete Team" />
                    }
                </MudButtonGroup>
            </MudTd>
        </RowTemplate>

        <NoRecordsContent>
            <MudText Typo="Typo.body1" Align="Align.Center" Class="pa-4">
                @if (!string.IsNullOrWhiteSpace(_searchTerm))
                {
                    <span>No teams found matching "@_searchTerm"</span>
                }
                else
                {
                    <span>No teams available</span>
                }
            </MudText>
        </NoRecordsContent>

        <LoadingContent>
            <MudText Typo="Typo.body1" Align="Align.Center" Class="pa-4">Loading teams...</MudText>
        </LoadingContent>

        <PagerContent>
            <MudTablePager HidePageNumber="false" PageSizeOptions="@_pageSizeOptions" />
        </PagerContent>
    </MudTable>
</MudPaper>

<ConfirmActionDialog Visible="_showDeactivateDialog"
                     VisibleChanged="v => _showDeactivateDialog = v"
                     Title="Confirm Deactivation"
                     TitleIcon="@Icons.Material.Filled.PauseCircle"
                     TitleIconColor="Color.Warning"
                     Message=@($"Are you sure you want to deactivate team <strong>{_selectedTeamName}</strong>?")
                     SecondaryMessage="This action can be reversed later."
                     SecondaryMessageColor="Color.Warning"
                     CancelText="CANCEL"
                     CancelVariant="Variant.Outlined"
                     ConfirmText="DEACTIVATE"
                     ConfirmIcon="@Icons.Material.Filled.Pause"
                     ConfirmColor="Color.Warning"
                     ConfirmVariant="Variant.Filled"
                     IsProcessing="false"
                     OnConfirm="ConfirmDeactivate"
                     Options="_dialogOptions" />

<ConfirmActionDialog Visible="_showActivateDialog"
                     VisibleChanged="v => _showActivateDialog = v"
                     Title="Confirm Activation"
                     TitleIcon="@Icons.Material.Filled.PlayCircle"
                     TitleIconColor="Color.Success"
                     Message=@($"Are you sure you want to activate team <strong>{_selectedTeamName}</strong>?")
                     SecondaryMessage="This action will make the team active again."
                     SecondaryMessageColor="Color.Success"
                     CancelText="CANCEL"
                     CancelVariant="Variant.Outlined"
                     ConfirmText="ACTIVATE"
                     ConfirmIcon="@Icons.Material.Filled.PlayArrow"
                     ConfirmColor="Color.Success"
                     ConfirmVariant="Variant.Filled"
                     IsProcessing="false"
                     OnConfirm="ConfirmActivate"
                     Options="_dialogOptions" />

<ConfirmActionDialog Visible="_showDeleteDialog"
                     VisibleChanged="v => _showDeleteDialog = v"
                     Title="Confirm Deletion"
                     TitleIcon="@Icons.Material.Filled.Warning"
                     TitleIconColor="Color.Error"
                     Message=@($"Are you sure you want to delete team <strong>{_selectedTeamName}</strong>?")
                     SecondaryMessage="This action cannot be undone."
                     SecondaryMessageColor="Color.Error"
                     CancelText="CANCEL"
                     CancelVariant="Variant.Outlined"
                     ConfirmText="DELETE"
                     ConfirmIcon="@Icons.Material.Filled.Delete"
                     ConfirmColor="Color.Error"
                     ConfirmVariant="Variant.Filled"
                     IsProcessing="false"
                     OnConfirm="ConfirmDelete"
                     Options="_dialogOptions" />

<MudDialog @bind-Visible="_showRenameDialog"
           Options="_dialogOptions"
           Class="confirm-action-dialog">
    <DialogContent>
        <div class="confirm-dialog-content">
            <div class="confirm-dialog-title-row">
                <MudIcon Icon="@Icons.Material.Filled.Edit"
                         Color="Color.Primary"
                         Size="Size.Medium"
                         Class="confirm-dialog-title-icon" />
                <MudText Typo="Typo.h6" Class="confirm-dialog-title-text">
                    Rename Team
                </MudText>
            </div>

            <MudText Typo="Typo.body2" Class="confirm-dialog-message">
                Current name: <strong>@_selectedTeamName</strong>
            </MudText>

            <MudTextField @bind-Value="_newTeamName"
                          Label="New team name"
                          Variant="Variant.Outlined"
                          Required="true"
                          RequiredError="Name is required"
                          MaxLength="150"
                          Counter="150"
                          Class="w-100" />
        </div>
    </DialogContent>

    <DialogActions>
        <div class="confirm-dialog-actions">
            <MudButton OnClick="@(() => _showRenameDialog = false)"
                       Color="Color.Default"
                       Variant="Variant.Outlined"
                       Size="Size.Medium"
                       Class="confirm-dialog-btn">
                CANCEL
            </MudButton>

            <MudButton OnClick="ConfirmRename"
                       Color="Color.Primary"
                       Variant="Variant.Filled"
                       Size="Size.Medium"
                       StartIcon="@Icons.Material.Filled.Save"
                       Disabled="_isRenaming || string.IsNullOrWhiteSpace(_newTeamName)"
                       Class="confirm-dialog-btn">
                @if (_isRenaming)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                <MudText>SAVE</MudText>
            </MudButton>
        </div>
    </DialogActions>
</MudDialog>

