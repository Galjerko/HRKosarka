@page "/clubs"
@using HRKošarka.UI.Services.Base
@using HRKošarka.UI.Components.Base
@using HRKošarka.UI.Models.UserManagement
@inherits HRKošarka.UI.Components.Base.PermissionBaseComponent

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5" Class="mb-4">Clubs Management</MudText>

    <MudTextField @bind-Value="_searchTerm"
                  Placeholder="Search clubs by name or city..."
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Search"
                  Class="mb-4"
                  Immediate="true"
                  DebounceInterval="300"
                  OnDebounceIntervalElapsed="OnSearchChanged" />

    <MudTable @ref="_table"
              ServerData="LoadServerData"
              SortLabel="Sort by"
              Sortable="true"
              Loading="_loading"
              Hover="true"
              Striped="true"
              Dense="true"
              FixedHeader="true"
              Height="600px">

        <ToolBarContent>
            <MudText Typo="Typo.h6">Clubs</MudText>
            <MudSpacer />
            @if (CanCreate)
            {
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="CreateClub">
                    Add Club
                </MudButton>
            }
        </ToolBarContent>

        <HeaderContent>
            <MudTh>
                <MudTableSortLabel T="ClubDTO" SortLabel="Name">Name</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="ClubDTO" SortLabel="City">City</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="ClubDTO" SortLabel="FoundedYear">Year Founded</MudTableSortLabel>
            </MudTh>
            <MudTh>Status</MudTh>
            <MudTh Style="text-align: center">Actions</MudTh>
        </HeaderContent>

        <RowTemplate>
            @{
                var clubPermissions = GetClubPermissions(context.Id).Result;
            }

            <MudTd DataLabel="Name">
                <MudText Typo="Typo.body2">@context.Name</MudText>
            </MudTd>
            <MudTd DataLabel="City">
                <MudText Typo="Typo.body2">@context.City</MudText>
            </MudTd>
            <MudTd DataLabel="Founded Year">
                <MudText Typo="Typo.body2">@context.FoundedYear.Year</MudText>
            </MudTd>
            <MudTd DataLabel="Status">
                <MudChip T="string"
                         Color="@(context.IsActive ? Color.Success : Color.Error)"
                         Size="Size.Small">
                    @(context.IsActive ? "Active" : "Inactive")
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Actions" Style="text-align: center">
                <MudButtonGroup Variant="Variant.Text" Size="Size.Small">
                    <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                   Color="Color.Primary"
                                   Size="Size.Small"
                                   OnClick="@(() => ViewClub(context.Id))"
                                   Title="View Details" />

                    @if (clubPermissions.CanEdit && context.IsActive)
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                       Color="Color.Secondary"
                                       Size="Size.Small"
                                       OnClick="@(() => EditClub(context.Id))"
                                       Title="Edit Club" />
                    }

                    @if (clubPermissions.CanDeactivate && context.IsActive)
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.Block"
                                       Color="Color.Warning"
                                       Size="Size.Small"
                                       OnClick="@(() => DeactivateClub(context.Id, context.Name))"
                                       Title="Deactivate Club" />
                    }
                    else
                    {
                        @if (clubPermissions.CanDeactivate && !context.IsActive)
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.CheckCircle"
                                           Color="Color.Success"
                                           Size="Size.Small"
                                           OnClick="@(() => ActivateClub(context.Id, context.Name))"
                                           Title="Activate Club" />
                        }
                    }

                    @if (clubPermissions.CanDelete)
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Color="Color.Error"
                                       Size="Size.Small"
                                       OnClick="@(() => DeleteClub(context.Id, context.Name))"
                                       Title="Delete Club" />
                    }
                </MudButtonGroup>
            </MudTd>
        </RowTemplate>

        <NoRecordsContent>
            <MudText Typo="Typo.body1" Align="Align.Center" Class="pa-4">
                @if (!string.IsNullOrWhiteSpace(_searchTerm))
                {
                    <span>No clubs found matching "@_searchTerm"</span>
                }
                else
                {
                    <span>No clubs available</span>
                }
            </MudText>
        </NoRecordsContent>

        <LoadingContent>
            <MudText Typo="Typo.body1" Align="Align.Center" Class="pa-4">
                Loading clubs...
            </MudText>
        </LoadingContent>
        <PagerContent>
            <MudTablePager Class="styled-dropdown" HidePageNumber="false" PageSizeOptions="@_pageSizeOptions" />
        </PagerContent>
    </MudTable>
</MudPaper>

<ConfirmActionDialog Visible="_showDeactivateDialog"
                     VisibleChanged="v => _showDeactivateDialog = v"
                     Title="Confirm Deactivation"
                     TitleIcon="@Icons.Material.Filled.PauseCircle"
                     TitleIconColor="Color.Warning"
                     Message=@($"Are you sure you want to deactivate club <strong>{_selectedClubName}</strong>?")
                     SecondaryMessage="This action can be reversed later."
                     SecondaryMessageColor="Color.Warning"
                     CancelText="CANCEL"
                     CancelVariant="Variant.Outlined"
                     ConfirmText="DEACTIVATE"
                     ConfirmIcon="@Icons.Material.Filled.Pause"
                     ConfirmColor="Color.Warning"
                     ConfirmVariant="Variant.Filled"
                     IsProcessing="false"
                     OnConfirm="ConfirmDeactivate"
                     Options="_dialogOptions" />

<ConfirmActionDialog Visible="_showActivateDialog"
                     VisibleChanged="v => _showActivateDialog = v"
                     Title="Confirm Activation"
                     TitleIcon="@Icons.Material.Filled.PlayCircle"
                     TitleIconColor="Color.Success"
                     Message=@($"Are you sure you want to activate club <strong>{_selectedClubName}</strong>?")
                     SecondaryMessage="This action will make the club active again."
                     SecondaryMessageColor="Color.Success"
                     CancelText="CANCEL"
                     CancelVariant="Variant.Outlined"
                     ConfirmText="ACTIVATE"
                     ConfirmIcon="@Icons.Material.Filled.PlayArrow"
                     ConfirmColor="Color.Success"
                     ConfirmVariant="Variant.Filled"
                     IsProcessing="false"
                     OnConfirm="ConfirmActivate"
                     Options="_dialogOptions" />

<ConfirmActionDialog Visible="_showDeleteDialog"
                     VisibleChanged="v => _showDeleteDialog = v"
                     Title="Confirm Deletion"
                     TitleIcon="@Icons.Material.Filled.Warning"
                     TitleIconColor="Color.Error"
                     Message=@($"Are you sure you want to delete club <strong>{_selectedClubName}</strong>?")
                     SecondaryMessage="This action cannot be undone."
                     SecondaryMessageColor="Color.Error"
                     CancelText="CANCEL"
                     CancelVariant="Variant.Outlined"
                     ConfirmText="DELETE"
                     ConfirmIcon="@Icons.Material.Filled.Delete"
                     ConfirmColor="Color.Error"
                     ConfirmVariant="Variant.Filled"
                     IsProcessing="false"
                     OnConfirm="ConfirmDelete"
                     Options="_dialogOptions" />
